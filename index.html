<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FiiO M21 EQ Preset Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Tealwave Palette */
            --bg-dark: #003840;      /* Dark Teal */
            --bg-mid: #005f6b;       /* Mid Teal */
            --bg-light: #00818a;     /* Light Teal */
            --text-primary: #e6fffa; /* Very Light Mint */
            --text-secondary: #7fffd4; /* Aquamarine */
            --text-header: #a7ffeb;   /* Bright Mint */
            --accent-pink: #f9258a;
            --accent-cyan: #00f5d4;
        }
        .genre-button {
            background-color: var(--bg-light);
            transition: background-color 0.2s, color 0.2s;
        }
        .genre-button:hover {
            background-color: var(--accent-pink);
            color: white;
        }
        .active-genre {
            background-color: var(--accent-pink);
            color: white;
        }
        .x-axis path, .x-axis line, .y-axis path, .y-axis line {
            stroke: var(--bg-light);
        }
        .x-axis text, .y-axis text {
            fill: var(--text-secondary);
        }
        .grid line {
            stroke: var(--bg-mid);
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 8px;
            font-size: 12px;
            background: var(--bg-mid);
            border: 1px solid var(--accent-pink);
            border-radius: 8px;
            pointer-events: none;
            color: var(--text-primary);
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
</head>
<body style="background-color: var(--bg-dark); color: var(--text-primary);">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold" style="color: var(--text-header);">FiiO M21 EQ Preset Guide</h1>
            <p class="mt-2" style="color: var(--text-secondary);">Optimal EQ curves based on audio science for various music genres.</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Genre List -->
            <aside class="w-full lg:w-1/4">
                <div class="rounded-lg shadow-lg p-4" style="background-color: var(--bg-mid);">
                    <h2 class="text-xl font-semibold mb-4" style="color: var(--text-header);">Select Genre</h2>
                    <ul id="genre-list" class="space-y-2">
                        <!-- Genres will be populated by JS -->
                    </ul>
                </div>
            </aside>

            <!-- EQ Details and Visualization -->
            <main class="w-full lg:w-3/4">
                <div id="eq-details-container" class="rounded-lg shadow-lg p-6 md:p-8" style="background-color: var(--bg-mid);">
                    <h2 id="current-genre-title" class="text-2xl md:text-3xl font-bold mb-2" style="color: var(--text-header);"></h2>
                    <p id="genre-description" class="mb-6" style="color: var(--text-secondary);"></p>

                    <!-- EQ Visualization -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-4" style="color: var(--text-header);">EQ Curve Visualization</h3>
                        <div id="eq-chart" class="w-full h-64 md:h-80 rounded-md" style="background-color: var(--bg-dark); border: 1px solid var(--bg-light);"></div>
                        <div class="tooltip"></div>
                    </div>

                    <!-- EQ Settings Table -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4" style="color: var(--text-header);">FiiO M21 Settings</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-left">
                                <thead style="background-color: var(--bg-light);">
                                    <tr>
                                        <th class="p-3 font-semibold">Filter</th>
                                        <th class="p-3 font-semibold">Frequency (Hz)</th>
                                        <th class="p-3 font-semibold">Gain (dB)</th>
                                        <th class="p-3 font-semibold">Q Factor</th>
                                    </tr>
                                </thead>
                                <tbody id="settings-table-body" style="background-color: var(--bg-mid);">
                                    <!-- Settings will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
         <footer class="text-center mt-8 text-sm" style="color: var(--text-secondary);">
            <p>The 'Q' factor determines the bandwidth of the adjustment. A lower Q value (e.g., 0.7) creates a broad, gentle curve affecting a wider range of frequencies. A higher Q value (e.g., 2.0+) creates a narrow, sharp peak for more surgical changes.</p>
        </footer>
    </div>

    <script>
        const eqPresets = {
            "Classic Rock": {
                description: "Emphasizes punchy drums and crunchy guitars. A slight 'smiley face' curve brings out the kick drum and cymbals, with warmth in the mids.",
                settings: [
                    { freq: 60, gain: 2.5, q: 0.7, type: 'low_shelf' },
                    { freq: 250, gain: -1.0, q: 1.5 },
                    { freq: 1500, gain: 1.5, q: 1.2 },
                    { freq: 4000, gain: 2.0, q: 1.0 },
                    { freq: 8000, gain: 1.5, q: 1.5, type: 'high_shelf' }
                ]
            },
            "Metal": {
                description: "A modern metal sound with a tight, aggressive low-end and clear, cutting highs for articulate riffs and cymbals. The scooped mids create space.",
                settings: [
                    { freq: 80, gain: 3.0, q: 1.0 },
                    { freq: 400, gain: -4.0, q: 1.2 },
                    { freq: 1000, gain: -2.0, q: 2.0 },
                    { freq: 5000, gain: 3.5, q: 1.5 },
                    { freq: 10000, gain: 2.5, q: 2.0, type: 'high_shelf' }
                ]
            },
            "Desert Metal": {
                description: "Thick, fuzzy, and warm. Boosted low-mids replicate the sound of vintage tube amps, with a rolled-off high-end to reduce harshness.",
                settings: [
                    { freq: 100, gain: 3.5, q: 0.8 },
                    { freq: 500, gain: 4.0, q: 0.9 },
                    { freq: 2000, gain: -2.5, q: 1.5 },
                    { freq: 6000, gain: -3.0, q: 1.0, type: 'high_shelf' }
                ]
            },
            "Pop": {
                description: "Designed for clarity and impact. A clean, powerful bass, clear vocals, and crisp highs make modern pop tracks shine.",
                settings: [
                    { freq: 40, gain: 3.0, q: 1.0, type: 'low_shelf' },
                    { freq: 200, gain: -1.5, q: 1.8 },
                    { freq: 2500, gain: 2.0, q: 1.4 },
                    { freq: 12000, gain: 3.5, q: 0.7, type: 'high_shelf' }
                ]
            },
            "Jazz": {
                description: "Focuses on natural timbre and realism. A gentle touch to enhance the warmth of acoustic bass, the body of pianos, and the shimmer of cymbals.",
                settings: [
                    { freq: 80, gain: 1.5, q: 0.9 },
                    { freq: 800, gain: -1.0, q: 1.2 },
                    { freq: 3000, gain: 1.0, q: 1.5 },
                    { freq: 7000, gain: 2.0, q: 1.0 }
                ]
            },
            "Classical": {
                description: "A relatively flat curve to preserve the natural dynamics and tonal balance of the orchestra. Minor adjustments add body and air without coloration.",
                settings: [
                    { freq: 100, gain: 1.0, q: 0.7 },
                    { freq: 3000, gain: -0.5, q: 2.0 },
                    { freq: 10000, gain: 1.5, q: 0.8 }
                ]
            },
            "R&B": {
                description: "Smooth and soulful. Elevated bass provides a deep foundation, while a boost in the upper-mids brings vocals forward with intimacy and clarity.",
                settings: [
                    { freq: 50, gain: 4.0, q: 0.9, type: 'low_shelf' },
                    { freq: 600, gain: -2.0, q: 1.5 },
                    { freq: 3000, gain: 2.5, q: 1.2 },
                    { freq: 10000, gain: 2.0, q: 1.5 }
                ]
            },
            "Funk": {
                description: "All about the groove. A tight, punchy bass line and crisp, snappy snare are key. This curve highlights the rhythm section.",
                settings: [
                    { freq: 90, gain: 3.5, q: 1.2 },
                    { freq: 400, gain: -2.5, q: 1.4 },
                    { freq: 2500, gain: 2.0, q: 1.8 },
                    { freq: 5000, gain: 3.0, q: 1.5 }
                ]
            },
            "Acoustic/Folk": {
                description: "Pristine and natural. This preset aims for transparency, reducing boominess in the low-mids and adding a touch of sparkle for string detail.",
                settings: [
                    { freq: 80, gain: -1.5, q: 1.0 },
                    { freq: 200, gain: -2.5, q: 1.5 },
                    { freq: 3000, gain: 1.5, q: 1.8 },
                    { freq: 9000, gain: 2.5, q: 1.2 }
                ]
            },
            "Electronic/EDM": {
                description: "Maximum impact and energy. A deep sub-bass boost for visceral rumble and elevated highs for synthetic detail and atmospheric effects.",
                settings: [
                    { freq: 35, gain: 4.5, q: 0.9, type: 'low_shelf' },
                    { freq: 250, gain: -2.0, q: 1.5 },
                    { freq: 6000, gain: 2.5, q: 1.5 },
                    { freq: 12000, gain: 4.0, q: 1.0, type: 'high_shelf' }
                ]
            }
        };

        const genreList = document.getElementById('genre-list');
        const currentGenreTitle = document.getElementById('current-genre-title');
        const genreDescription = document.getElementById('genre-description');
        const settingsTableBody = document.getElementById('settings-table-body');
        const chartContainer = document.getElementById('eq-chart');

        let activeGenre = "Classic Rock";

        function renderGenreList() {
            genreList.innerHTML = '';
            Object.keys(eqPresets).forEach(genre => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.textContent = genre;
                // Use a base class for styling and add active-genre conditionally
                button.className = `genre-button w-full text-left p-3 rounded-md`;
                if (genre === activeGenre) {
                    button.classList.add('active-genre');
                }
                button.onclick = () => {
                    activeGenre = genre;
                    renderAll();
                };
                li.appendChild(button);
                genreList.appendChild(li);
            });
        }

        function renderDetails() {
            const preset = eqPresets[activeGenre];
            currentGenreTitle.textContent = activeGenre;
            genreDescription.textContent = preset.description;

            settingsTableBody.innerHTML = '';
            preset.settings.forEach((setting, index) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--bg-light)';
                row.innerHTML = `
                    <td class="p-3">Peak ${index + 1}</td>
                    <td class="p-3">${setting.freq}</td>
                    <td class="p-3">${setting.gain.toFixed(1)}</td>
                    <td class="p-3">${setting.q.toFixed(1)}</td>
                `;
                settingsTableBody.appendChild(row);
            });
        }

        function drawChart() {
            d3.select(chartContainer).select("svg").remove();
            const preset = eqPresets[activeGenre];

            const margin = { top: 20, right: 40, bottom: 40, left: 40 };
            const width = chartContainer.clientWidth - margin.left - margin.right;
            const height = chartContainer.clientHeight - margin.top - margin.bottom;
            
            if (width <= 0 || height <= 0) return;

            const svg = d3.select(chartContainer).append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const frequencies = [20, 50, 100, 200, 500, 1000, 2000, 5000, 10000, 20000];
            const xScale = d3.scaleLog()
                .domain([20, 20000])
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([-8, 8])
                .range([height, 0]);

            // Add X axis
            const xAxis = d3.axisBottom(xScale)
                .tickValues(frequencies)
                .tickFormat(d3.format("~s"));
            svg.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0, ${height})`)
                .call(xAxis);

            // Add Y axis
            const yAxis = d3.axisLeft(yScale).ticks(5);
            svg.append("g")
                .attr("class", "y-axis")
                .call(yAxis);
                
            // Add Y axis label
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x",0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("fill", "var(--text-secondary)")
                .style("font-size", "12px")
                .text("Gain (dB)");
                
            // Add X axis label
            svg.append("text")             
                .attr("transform", `translate(${width/2}, ${height + margin.bottom - 5})`)
                .style("text-anchor", "middle")
                .style("fill", "var(--text-secondary)")
                .style("font-size", "12px")
                .text("Frequency (Hz)");

            // Add grid lines
            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(yScale).ticks(5).tickSize(-width).tickFormat(""));
                
            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisBottom(xScale).tickValues(frequencies).tickSize(height).tickFormat(""));


            // Calculate combined EQ curve
            const curvePoints = [];
            for (let f = 20; f <= 20000; f *= 1.05) {
                let totalGain = 0;
                preset.settings.forEach(s => {
                    const { freq, gain, q } = s;
                    // Peaking filter formula (simplified)
                    const normalizedFreq = f / freq;
                    totalGain += gain / (1 + Math.pow((normalizedFreq * normalizedFreq - 1) / (normalizedFreq / q), 2));
                });
                curvePoints.push({ freq: f, gain: totalGain });
            }

            // Draw the EQ curve
            const line = d3.line()
                .x(d => xScale(d.freq))
                .y(d => yScale(d.gain))
                .curve(d3.curveBasis);

            svg.append("path")
                .datum(curvePoints)
                .attr("fill", "none")
                .attr("stroke", "var(--accent-pink)")
                .attr("stroke-width", 3)
                .attr("d", line);

            // Add points for each setting
             const tooltip = d3.select(".tooltip");

            svg.selectAll("dot")
                .data(preset.settings)
                .enter()
                .append("circle")
                .attr("cx", d => xScale(d.freq))
                .attr("cy", d => yScale(d.gain))
                .attr("r", 6)
                .attr("fill", "var(--accent-cyan)")
                .attr("stroke", "var(--text-primary)")
                .attr("stroke-width", 2)
                .on("mouseover", function(event, d) {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(`Freq: ${d.freq} Hz<br/>Gain: ${d.gain} dB<br/>Q: ${d.q}`)
                        .style("left", (event.pageX + 15) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition().duration(500).style("opacity", 0);
                });
        }

        function renderAll() {
            renderGenreList();
            renderDetails();
            drawChart();
        }

        window.onload = renderAll;
        window.onresize = drawChart;

    </script>
</body>
</html>
